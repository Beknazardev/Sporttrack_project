<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>SportTrack — Регистрация</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>

    <div class="logo">SportTrack</div>

    <div class="card" id="registerSection">
        <h1 data-i18n="reg_title">Регистрация</h1>

        <label data-i18n="reg_email_label">Почта</label>
        <input type="email" id="email" placeholder="Email">

        <label data-i18n="reg_username_label">Имя</label>
        <input type="text" id="username" placeholder="Имя">

        <label data-i18n="reg_lastname_label">Фамилия</label>
        <input type="text" id="lastname" placeholder="Фамилия">

        <label data-i18n="reg_password_label">Пароль</label>
        <input type="password" id="password" placeholder="Пароль">

        <label data-i18n="reg_sport_label">Введите ваш вид спорта</label>
        <input type="text" id="sportInput" placeholder="Например: Футбол, Бокс...">
        <p id="sportOutput"></p>

        <label data-i18n="reg_role_label">Выберите роль</label>
        <select id="role">
            <option value="athlete" data-i18n="reg_role_athlete">Спортсмен</option>
            <option value="coach" data-i18n="reg_role_coach">Тренер</option>
        </select>

        
        <select id="langSelect" class="lang-select">
            <option value="ru">Рус</option>
            <option value="kz">Қаз</option>
            <option value="en">Eng</option>
        </select>

        <button id="registerBtn" class="btn-primary" data-i18n="reg_button">Зарегистрироваться</button>
    </div>

    <div class="card hidden" id="confirmSection">
        <h1 data-i18n="confirm_title">Подтверждение почты</h1>

        <p data-i18n="confirm_desc">
            Мы отправили код подтверждения на вашу почту.
        </p>

        <p><b>Email:</b> <span id="confirmEmailText"></span></p>

        <label data-i18n="confirm_code_label">Код из письма</label>
        <input type="text" id="confirmCode" placeholder="123456">

        <button id="confirmBtn" class="btn-primary" data-i18n="confirm_button">Подтвердить</button>

        <a href="register.html" class="back-link" data-i18n="back_to_reg">← Назад к регистрации</a>
    </div>

    <script src="lang.js"></script>

    <script>
        const API_BASE = "http://localhost:8000";

        const sportInput = document.getElementById("sportInput");
        const sportOutput = document.getElementById("sportOutput");

        const registerSection = document.getElementById("registerSection");
        const confirmSection = document.getElementById("confirmSection");
        const confirmEmailText = document.getElementById("confirmEmailText");

        sportInput.addEventListener("input", () => {
            const sport = sportInput.value.trim();
            const lang = localStorage.getItem("lang") || "ru";

            let label = "Вид спорта: ";
            if (lang === "en") label = "Sport: ";
            if (lang === "kz") label = "Спорт түрі: ";

            sportOutput.textContent = sport ? label + sport : "";
        });

        document.getElementById("registerBtn").addEventListener("click", async () => {
            const email = document.getElementById("email").value.trim();
            const username = document.getElementById("username").value.trim();
            const lastname = document.getElementById("lastname").value.trim();
            const password = document.getElementById("password").value.trim();
            const sport = document.getElementById("sportInput").value.trim();
            const role = document.getElementById("role").value;

            if (!email || !username || !lastname || !password || !sport) {
                alert("Заполните все поля!");
                return;
            }

            localStorage.setItem("pending_user", JSON.stringify({
                email, username, last_name: lastname, sport, role
            }));

            const res = await fetch(`${API_BASE}/api/register`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email, username, password, role })
            });

            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                alert(err.detail || "Ошибка регистрации");
                return;
            }

            registerSection.classList.add("hidden");
            confirmSection.classList.remove("hidden");
            confirmEmailText.textContent = email;
        });

        document.getElementById("confirmBtn").addEventListener("click", async () => {
            const code = document.getElementById("confirmCode").value.trim();
            const pending = JSON.parse(localStorage.getItem("pending_user"));
            if (!pending) {
                alert("Сессия утеряна");
                return;
            }

            const res = await fetch(`${API_BASE}/api/email/confirm`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email: pending.email, code })
            });

            if (!res.ok) {
                alert("Неверный код");
                return;
            }

            const user = await res.json();

            localStorage.setItem("user", JSON.stringify({
                id: user.id,
                email: user.email,
                username: user.username,
                last_name: pending.last_name,
                sport: pending.sport,
                role: user.role
            }));

            localStorage.removeItem("pending_user");

            if (user.role === "coach") {
                window.location.href = "coach_page.html";
            } else {
                window.location.href = "athlete_page.html";
            }
        });
    </script>
</body>
</html>
