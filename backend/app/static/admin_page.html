<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SportTrack ‚Äî –ö–∞–±–∏–Ω–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="lang.js"></script>
  <style>
    /* —á—Ç–æ–±—ã –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ—á–Ω–æ –±—ã–ª–∏ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ */
    .coach-menu__item{ display:flex; text-decoration:none; cursor:pointer; }
    .coach-menu__item *{ pointer-events:none; }
    .coach-menu__item{ pointer-events:auto; }
  </style>
</head>
<body>
<header class="top-bar">
  <div class="top-bar__logo">SportTrack</div>
  <div class="top-bar__lang">
    <select id="langSelect" class="lang-select">
      <option value="ru">–†—É—Å—Å–∫–∏–π</option>
      <option value="en">English</option>
      <option value="kz">“ö–∞–∑–∞“õ—à–∞</option>
    </select>
  </div>
</header>

<main class="coach-layout coach-layout--dashboard">
  <!-- Left profile card -->
  <section class="panel coach-card coach-card--dashboard">
    <div class="coach-card__top">
      <div class="coach-avatar coach-avatar--coach">
        <span id="adminAvatarLetter" class="coach-avatar__text"></span>
      </div>
      <div class="coach-card__info">
        <h1 id="adminName" class="coach-name"></h1>
        <p class="coach-status"><span>–°—Ç–∞—Ç—É—Å:</span> <strong>–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</strong></p>
        <button id="editProfileBtn" class="btn-link">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
      </div>
    </div>
    <div class="coach-card__extra">
      <div class="coach-info-row">
        <span class="coach-label">ID:</span>
        <span id="adminIdValue"></span>
      </div>
      <div class="coach-info-row">
        <span class="coach-label">Email:</span>
        <span id="adminEmailValue"></span>
      </div>
      <div class="coach-info-row">
        <span class="coach-label">–§–∞–º–∏–ª–∏—è:</span>
        <span id="adminLastNameValue"></span>
      </div>
    </div>
  </section>

  <section class="coach-right coach-right--dashboard">
    <div class="coach-right-header">
      <h2 class="coach-welcome">
        <span>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</span>, <span id="adminFullName"></span>
      </h2>
      <button id="openChatFromAdmin" class="btn-primary">üí¨ <span>–ß–∞—Ç</span></button>
    </div>

    <section class="coach-menu">
      <a href="admin_users.html" class="coach-menu__item">
        <div class="coach-menu__icon">üë•</div>
        <div class="coach-menu__text">
          <div class="coach-menu__title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</div>
          <div class="coach-menu__sub">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, —Ç—Ä–µ–Ω–µ—Ä—ã, —Å–ø–æ—Ä—Ç—Å–º–µ–Ω—ã</div>
        </div>
      </a>

      <a href="admin_activity.html" class="coach-menu__item">
        <div class="coach-menu__icon">üìä</div>
        <div class="coach-menu__text">
          <div class="coach-menu__title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</div>
          <div class="coach-menu__sub">–û—Ç—á—ë—Ç—ã –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
        </div>
      </a>

      <a href="admin_requests.html" class="coach-menu__item">
        <div class="coach-menu__icon">üßæ</div>
        <div class="coach-menu__text">
          <div class="coach-menu__title">–ó–∞–ø—Ä–æ—Å—ã</div>
          <div class="coach-menu__sub">–ó–∞—è–≤–∫–∏ –∏ –æ–±—Ä–∞—â–µ–Ω–∏—è</div>
        </div>
      </a>

      <a href="admin_settings.html" class="coach-menu__item">
        <div class="coach-menu__icon">‚öôÔ∏è</div>
        <div class="coach-menu__text">
          <div class="coach-menu__title">–°–∏—Å—Ç–µ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</div>
          <div class="coach-menu__sub">–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã</div>
        </div>
      </a>
    </section>
  </section>

  <!-- Bottom left stats summary -->
  <section class="coach-summary coach-summary--dashboard">
    <div class="coach-summary__item">
      <span id="cntUsers">‚Äî</span>
      <span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</span>
    </div>
    <div class="coach-summary__item">
      <span id="cntCoaches">‚Äî</span>
      <span>–¢—Ä–µ–Ω–µ—Ä–æ–≤</span>
    </div>
    <div class="coach-summary__item">
      <span id="cntAthletes">‚Äî</span>
      <span>–°–ø–æ—Ä—Ç—Å–º–µ–Ω–æ–≤</span>
    </div>
  </section>

  <!-- Right activity panel -->
  <section class="panel activity-panel activity-panel--dashboard">
    <div class="panel-header">
      <h2 class="page-subtitle">–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h2>
    </div>
    <div id="adminActivity" class="list muted">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  </section>
</main>

<script>
  const API = "";

  const raw = localStorage.getItem("user");
  if (!raw) location.href = "login.html";
  const user = JSON.parse(raw);

  if ((user.role || "").toLowerCase() !== "admin") location.href = "login.html";

  const fullName = (user.last_name ? `${user.username} ${user.last_name}` : (user.username || "")).trim();

  document.getElementById("adminName").textContent = user.username || "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä";
  document.getElementById("adminFullName").textContent = fullName || "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä";
  document.getElementById("adminIdValue").textContent = user.id ?? "‚Äî";
  document.getElementById("adminEmailValue").textContent = user.email ?? "‚Äî";
  document.getElementById("adminLastNameValue").textContent = user.last_name ?? "‚Äî";

  const first = (user.username || "").trim()[0];
  document.getElementById("adminAvatarLetter").textContent = first ? first.toUpperCase() : "A";

  document.getElementById("editProfileBtn").onclick = () => location.href = "profile_edit.html";
  document.getElementById("openChatFromAdmin").onclick = () => location.href = "chat.html";

  function fmtDate(d){
    try { return new Date(d).toLocaleString(); } catch { return ""; }
  }
  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;");
  }

  async function loadStats(){
    try{
      const res = await fetch(`${API}/api/admin/stats`, { headers: { "Accept":"application/json" } });
      const data = await res.json().catch(()=> ({}));
      if (!res.ok) throw new Error(data?.detail || ("HTTP " + res.status));

      document.getElementById("cntUsers").textContent = data.total_users ?? 0;
      document.getElementById("cntCoaches").textContent = data.total_coaches ?? 0;
      document.getElementById("cntAthletes").textContent = data.total_athletes ?? 0;
    } catch(e){
      console.error(e);
      document.getElementById("cntUsers").textContent = "‚Äî";
      document.getElementById("cntCoaches").textContent = "‚Äî";
      document.getElementById("cntAthletes").textContent = "‚Äî";
    }
  }

  async function loadAdminActivity(){
    const el = document.getElementById("adminActivity");
    el.innerHTML = `<div class="muted">–ó–∞–≥—Ä—É–∑–∫–∞...</div>`;

    try{
      const res = await fetch(`${API}/api/admin/activity?admin_id=${encodeURIComponent(user.id)}&limit=6`, {
        headers: { "Accept":"application/json" }
      });
      const data = await res.json().catch(()=>[]);
      if (!res.ok || !Array.isArray(data) || data.length === 0){
        el.innerHTML = `<div class="muted">–ü–æ–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–µ—Ç</div>`;
        return;
      }

      el.innerHTML = data.map(a => `
        <div class="list-item">
          <div>
            <div class="list-title">${esc(a.title || "–°–æ–±—ã—Ç–∏–µ")}</div>
            <div class="list-sub">${esc(a.message || "")}</div>
          </div>
          <span class="badge">${a.created_at ? esc(fmtDate(a.created_at)) : ""}</span>
        </div>
      `).join("");
    } catch(e){
      console.error(e);
      el.innerHTML = `<div class="muted">–ü–æ–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–µ—Ç</div>`;
    }
  }

  (async () => {
    await loadStats();
    await loadAdminActivity();
  })();
</script>
</body>
</html>


