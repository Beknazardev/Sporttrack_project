<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SportTrack ‚Äî –ö–∞–±–∏–Ω–µ—Ç —Ç—Ä–µ–Ω–µ—Ä–∞</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="lang.js"></script>

  <style>
    /* —á—Ç–æ–±—ã –∫–∞—Ä—Ç–æ—á–∫–∏ –º–µ–Ω—é 100% –±—ã–ª–∏ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ */
    .coach-menu__item{ display:flex; text-decoration:none; cursor:pointer; }
    .coach-menu__item *{ pointer-events:none; }
    .coach-menu__item{ pointer-events:auto; }
  </style>
</head>

<body>
<header class="top-bar">
  <div class="top-bar__logo" data-i18n="app_title">SportTrack</div>
  <div class="top-bar__lang">
    <select id="langSelect" class="lang-select">
      <option value="ru" data-i18n="lang_ru">–†—É—Å—Å–∫–∏–π</option>
      <option value="en" data-i18n="lang_en">English</option>
      <option value="kz" data-i18n="lang_kz">“ö–∞–∑–∞“õ—à–∞</option>
    </select>
  </div>
</header>

<main class="coach-layout coach-layout--dashboard">

  <!-- Left profile card -->
  <section class="panel coach-card coach-card--dashboard">
    <div class="coach-card__top">
      <div class="coach-avatar coach-avatar--coach">
        <span id="coachAvatarLetter" class="coach-avatar__text">C</span>
      </div>

      <div class="coach-card__info">
        <h1 id="coachName" class="coach-name">‚Äî</h1>

        <p class="coach-status">
          <span>–°—Ç–∞—Ç—É—Å:</span> <strong>—Ç—Ä–µ–Ω–µ—Ä</strong>
        </p>

        <button id="editProfileBtn" class="btn-link">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
      </div>
    </div>

    <div class="coach-card__extra">
      <div class="coach-info-row">
        <span class="coach-label">ID:</span>
        <span id="coachIdValue">‚Äî</span>
      </div>

      <div class="coach-info-row">
        <span class="coach-label">–§–∞–º–∏–ª–∏—è:</span>
        <span id="coachLastNameValue">‚Äî</span>
      </div>

      <div class="coach-info-row">
        <span class="coach-label">Email:</span>
        <span id="coachEmailValue">‚Äî</span>
      </div>
    </div>
  </section>

  <section class="coach-right coach-right--dashboard">
    <div class="coach-right-header">
      <h2 class="coach-welcome">
        <span>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</span>, <span id="coachFullName">‚Äî</span>
      </h2>

      <button id="openChatFromCoach" class="btn-primary">
        üí¨ <span>–ß–∞—Ç</span>
      </button>
    </div>

    <section class="coach-menu">
      <a href="coach_athletes.html" class="coach-menu__item">
        <div class="coach-menu__icon">üëü</div>
        <div class="coach-menu__text">
          <div class="coach-menu__title">–°–ø–æ—Ä—Ç—Å–º–µ–Ω—ã</div>
          <div class="coach-menu__sub">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
        </div>
      </a>

      <a href="coach_tasks.html" class="coach-menu__item">
        <div class="coach-menu__icon">üìù</div>
        <div class="coach-menu__text">
          <div class="coach-menu__title">–ó–∞–¥–∞—á–∏</div>
          <div class="coach-menu__sub">–í—ã–¥–∞—á–∞ –∑–∞–¥–∞–Ω–∏–π</div>
        </div>
      </a>

      <a href="coach_plans.html" class="coach-menu__item">
        <div class="coach-menu__icon">üìÖ</div>
        <div class="coach-menu__text">
          <div class="coach-menu__title">–ü–ª–∞–Ω—ã</div>
          <div class="coach-menu__sub">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</div>
        </div>
      </a>

      <a href="coach_notifications.html" class="coach-menu__item">
        <div class="coach-menu__icon">üîî</div>
        <div class="coach-menu__text">
          <div class="coach-menu__title">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
          <div class="coach-menu__sub">–°—Ç–∞—Ç—É—Å—ã</div>
        </div>
      </a>
    </section>
  </section>

  <section class="coach-summary coach-summary--dashboard">
    <div class="coach-summary__item">
      <span id="cntAthletes">0</span>
      <span>–°–ø–æ—Ä—Ç—Å–º–µ–Ω–æ–≤</span>
    </div>
    <div class="coach-summary__item">
      <span id="cntPlans">0</span>
      <span>–ü–ª–∞–Ω–æ–≤</span>
    </div>
    <div class="coach-summary__item">
      <span id="cntTasks">0</span>
      <span>–ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á</span>
    </div>
  </section>

  <section class="panel activity-panel activity-panel--dashboard">
    <div class="panel-header">
      <h2 class="page-subtitle">–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h2>
    </div>
    <div id="coachActivity" class="list muted">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  </section>

</main>

<script>
  const API = "";

  const raw = localStorage.getItem("user");
  if (!raw) location.href = "login.html";
  const me = JSON.parse(raw);

  if ((me.role || "").toLowerCase() !== "coach") location.href = "login.html";

  const elName = document.getElementById("coachName");
  const elFull = document.getElementById("coachFullName");
  const elId = document.getElementById("coachIdValue");
  const elLast = document.getElementById("coachLastNameValue");
  const elEmail = document.getElementById("coachEmailValue");
  const elAvatar = document.getElementById("coachAvatarLetter");

  function esc(s){
    return String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }
  function fmtDate(d){
    try { return new Date(d).toLocaleString(); } catch { return ""; }
  }

  async function loadProfile() {
    const username = me.username || "";
    const last_name = me.last_name || "";
    const email = me.email || "";
    const id = me.id ?? "";

    elName.textContent = username || "‚Äî";
    elFull.textContent = (username && last_name) ? `${username} ${last_name}` : (username || "‚Äî");
    elId.textContent = (id !== "" ? String(id) : "‚Äî");
    elLast.textContent = last_name || "‚Äî";
    elEmail.textContent = email || "‚Äî";

    const first = (username || "").trim()[0];
    elAvatar.textContent = first ? first.toUpperCase() : "C";


    try {
      if (me.id == null) return;
      const res = await fetch(`${API}/api/users/${encodeURIComponent(me.id)}`, { headers: { "Accept": "application/json" }});
      const data = await res.json().catch(() => null);
      if (!res.ok || !data) return;

      elName.textContent = data.username || elName.textContent;
      elFull.textContent = (data.username && data.last_name) ? `${data.username} ${data.last_name}` : (data.username || elFull.textContent);
      elId.textContent = (data.id != null ? String(data.id) : elId.textContent);
      elLast.textContent = data.last_name || elLast.textContent;
      elEmail.textContent = data.email || elEmail.textContent;

      const f = (data.username || "").trim()[0];
      elAvatar.textContent = f ? f.toUpperCase() : elAvatar.textContent;

      const merged = { ...me, ...data };
      localStorage.setItem("user", JSON.stringify(merged));
    } catch (e) {
      console.error("loadProfile error:", e);
    }
  }

  async function loadCounters() {
    try {
      const r = await fetch(`${API}/api/coach/athletes?coach_id=${encodeURIComponent(me.id)}&status=accepted`);
      const d = await r.json().catch(() => []);
      if (r.ok && Array.isArray(d)) {
        document.getElementById("cntAthletes").textContent = String(d.length);
      }
    } catch {}

    try {
      const r = await fetch(`${API}/api/coach/plans?coach_id=${encodeURIComponent(me.id)}`);
      const d = await r.json().catch(() => []);
      if (r.ok && Array.isArray(d)) {
        document.getElementById("cntPlans").textContent = String(d.length);
      }
    } catch {}

    try {
      const r = await fetch(`${API}/api/coach/tasks?coach_id=${encodeURIComponent(me.id)}`);
      const d = await r.json().catch(() => []);
      if (r.ok && Array.isArray(d)) {
        const active = d.filter(t => !["done","rated"].includes(String(t.status || "").toLowerCase()));
        document.getElementById("cntTasks").textContent = String(active.length);
      }
    } catch {}
  }

  async function loadCoachActivity() {
    const el = document.getElementById("coachActivity");
    el.innerHTML = `<div class="muted">–ó–∞–≥—Ä—É–∑–∫–∞...</div>`;

    try {
      const res = await fetch(`${API}/api/activity?user_id=${encodeURIComponent(me.id)}&limit=8`);
      const data = await res.json().catch(() => []);
      if (!res.ok || !Array.isArray(data) || data.length === 0) {
        el.innerHTML = `<div class="muted">–ü–æ–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–µ—Ç</div>`;
        return;
      }

      el.innerHTML = data.map(a => `
        <div class="list-item">
          <div>
            <div class="list-title">${esc(a.title || "–°–æ–±—ã—Ç–∏–µ")}</div>
            <div class="list-sub">${esc(a.message || "")}</div>
          </div>
          <span class="badge">${a.created_at ? fmtDate(a.created_at) : ""}</span>
        </div>
      `).join("");
    } catch (e) {
      console.error(e);
      el.innerHTML = `<div class="muted">–ù–µ—Ç —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º</div>`;
    }
  }

  document.getElementById("editProfileBtn").onclick = () => location.href = "profile_edit.html";
  document.getElementById("openChatFromCoach").onclick = () => location.href = "chat.html";

  loadProfile();
  loadCounters();
  loadCoachActivity();
</script>

</body>
</html>

