<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SportTrack ‚Äî –ö–∞–±–∏–Ω–µ—Ç —Ç—Ä–µ–Ω–µ—Ä–∞</title>
<link rel="stylesheet" href="styles.css">
<script src="lang.js"></script>
</head>

<body>
<header class="top-bar">
  <div class="top-bar__logo">SportTrack</div>
  
  <div class="top-bar__lang">
    <select id="langSelect" class="lang-select">
      <option value="ru">–†—É—Å—Å–∫–∏–π</option>
      <option value="en">English</option>
      <option value="kz">“ö–∞–∑–∞“õ—à–∞</option>
    </select>
  </div>
</header>

<main class="coach-layout coach-layout--dashboard">

  <!-- Left profile card -->
  <section class="panel coach-card coach-card--dashboard">
    <div class="coach-card__top">
      <div class="coach-avatar coach-avatar--coach">
        <span id="coachAvatarLetter" class="coach-avatar__text"></span>
      </div>

      <div class="coach-card__info">
        <h1 id="coachName" class="coach-name"></h1>

        <p class="coach-status">
          <span>–°—Ç–∞—Ç—É—Å:</span> <strong>—Ç—Ä–µ–Ω–µ—Ä</strong>
        </p>

        <button id="editProfileBtn" class="btn-link">
          –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
        </button>
      </div>
    </div>

    <div class="coach-card__extra">
      <div class="coach-info-row">
        <span class="coach-label">ID:</span>
        <span id="coachIdValue"></span>
      </div>

      <div class="coach-info-row">
        <span class="coach-label">Email:</span>
        <span id="coachEmailValue"></span>
      </div>
    </div>
  </section>

  <!-- Center main content with menu -->
  <section class="coach-right coach-right--dashboard">
    <div class="coach-right-header">
      <h2 class="coach-welcome">
        <span>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</span>,
        <span id="coachFullName"></span>
      </h2>

      <button id="openChatFromCoach" class="btn-primary">
        üí¨ <span>–ß–∞—Ç</span>
      </button>
    </div>

    <!-- 2x2 Grid for coach menu items -->
    <section class="coach-menu">
      <a href="coach_athletes.html" class="coach-menu__item">
        <div class="coach-menu__icon">üëü</div>
        <div class="coach-menu__text">
          <div class="coach-menu__title">–°–ø–æ—Ä—Ç—Å–º–µ–Ω—ã</div>
          <div class="coach-menu__sub">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
        </div>
      </a>

      <a href="coach_tasks.html" class="coach-menu__item">
        <div class="coach-menu__icon">üìù</div>
        <div class="coach-menu__text">
          <div class="coach-menu__title">–ó–∞–¥–∞—á–∏</div>
          <div class="coach-menu__sub">–í—ã–¥–∞—á–∞ –∑–∞–¥–∞–Ω–∏–π</div>
        </div>
      </a>

      <a href="coach_plans.html" class="coach-menu__item">
        <div class="coach-menu__icon">üìÖ</div>
        <div class="coach-menu__text">
          <div class="coach-menu__title">–ü–ª–∞–Ω—ã</div>
          <div class="coach-menu__sub">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</div>
        </div>
      </a>

      <a href="coach_notifications.html" class="coach-menu__item">
        <div class="coach-menu__icon">üîî</div>
        <div class="coach-menu__text">
          <div class="coach-menu__title">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
          <div class="coach-menu__sub">–°—Ç–∞—Ç—É—Å—ã</div>
        </div>
      </a>
    </section>
  </section>

  <!-- Bottom left stats summary -->
  <section class="coach-summary coach-summary--dashboard">
    <div class="coach-summary__item">
      <span id="cntAthletes">0</span>
      <span>–°–ø–æ—Ä—Ç—Å–º–µ–Ω–æ–≤</span>
    </div>

    <div class="coach-summary__item">
      <span id="cntPlans">0</span>
      <span>–ü–ª–∞–Ω–æ–≤</span>
    </div>

    <div class="coach-summary__item">
      <span id="cntTasks">0</span>
      <span>–ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á</span>
    </div>
  </section>

  <!-- Right activity panel -->
  <section class="panel activity-panel activity-panel--dashboard">
    <div class="panel-header">
      <h2 class="page-subtitle">–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h2>
    </div>
    <div id="coachActivity" class="list muted">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  </section>

</main>

<script>
  const API = "http://127.0.0.1:7003";

  const raw = localStorage.getItem("user");
  if (!raw) window.location.href = "login.html";

  const user = JSON.parse(raw);
  if (user.role !== "coach") window.location.href = "login.html";

  document.getElementById("coachName").textContent = user.username || "";
  document.getElementById("coachFullName").textContent = user.last_name ? `${user.username} ${user.last_name}` : (user.username || "");
  document.getElementById("coachIdValue").textContent = user.id ?? "";
  document.getElementById("coachEmailValue").textContent = user.email ?? "";

  const first = (user.username || "").trim()[0];
  document.getElementById("coachAvatarLetter").textContent = first ? first.toUpperCase() : "C";

  document.getElementById("editProfileBtn").onclick = () => {
    window.location.href = "profile_edit.html";
  };

  document.getElementById("openChatFromCoach").onclick = () => {
    window.location.href = "chat.html";
  };

  async function loadCoachActivity() {
    const el = document.getElementById("coachActivity");
    el.innerHTML = `<div class="muted">–ó–∞–≥—Ä—É–∑–∫–∞...</div>`;

    try {
      const res = await fetch(`${API}/api/activity?user_id=${user.id}&limit=6`);
      if (!res.ok) {
        el.innerHTML = `<div class="muted">–ü–æ–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–µ—Ç</div>`;
        return;
      }
      const data = await res.json().catch(() => []);
      if (!Array.isArray(data) || data.length === 0) {
        el.innerHTML = `<div class="muted">–ü–æ–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–µ—Ç</div>`;
        return;
      }

      el.innerHTML = data.map(a => `
        <div class="list-item">
          <div>
            <div class="list-title">${a.title || "–°–æ–±—ã—Ç–∏–µ"}</div>
            <div class="list-sub">${a.message || ""}</div>
          </div>
          <span class="badge">${a.created_at ? new Date(a.created_at).toLocaleString() : ""}</span>
        </div>
      `).join("");

    } catch (e) {
      console.error(e);
      el.innerHTML = `<div class="muted">–ü–æ–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–µ—Ç</div>`;
    }
  }

  loadCoachActivity();
</script>

</body>
</html>
