<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SportTrack ‚Äî –ö–∞–±–∏–Ω–µ—Ç —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="lang.js"></script>
</head>
<body>

<header class="top-bar">
  <div class="top-bar__logo">SportTrack</div>

  <div class="top-bar__lang">
    <select id="langSelect" class="lang-select">
      <option value="ru">–†—É—Å—Å–∫–∏–π</option>
      <option value="en">English</option>
      <option value="kz">“ö–∞–∑–∞“õ—à–∞</option>
    </select>
  </div>
</header>

<main class="coach-layout coach-layout--dashboard">

  <!-- Left profile card -->
  <section class="panel coach-card coach-card--dashboard">
    <div class="coach-card__top">
      <div class="coach-avatar">
        <span id="athleteAvatarLetter" class="coach-avatar__text"></span>
      </div>

      <div class="coach-card__info">
        <h1 id="athleteName" class="coach-name"></h1>

        <p class="coach-status">
          <span>–°—Ç–∞—Ç—É—Å:</span> <strong>—Å–ø–æ—Ä—Ç—Å–º–µ–Ω</strong>
        </p>

        <button id="editProfileBtn" class="btn-link">
          –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
        </button>
      </div>
    </div>

    <div class="coach-card__extra">
      <div class="coach-info-row">
        <span class="coach-label">ID:</span>
        <span id="athleteIdValue"></span>
      </div>

      <div class="coach-info-row">
        <span class="coach-label">Email:</span>
        <span id="athleteEmailValue"></span>
      </div>

      <div class="coach-info-row">
        <span class="coach-label">–í–∏–¥ —Å–ø–æ—Ä—Ç–∞:</span>
        <span id="athleteSportValue">‚Äî</span>
      </div>
    </div>
  </section>

  <!-- Bottom left stats summary -->
  <section class="coach-summary coach-summary--dashboard">
    <div class="coach-summary__item">
      <span id="athPlans">0</span>
      <span>–ü–ª–∞–Ω–æ–≤</span>
    </div>

    <div class="coach-summary__item">
      <span id="athWorkouts">0</span>
      <span>–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</span>
    </div>

    <div class="coach-summary__item">
      <span id="athTasks">0</span>
      <span>–ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á</span>
    </div>
  </section>

  <!-- Center main content -->
  <section class="coach-right coach-right--dashboard">

    <div class="coach-right-header">
      <h2 class="coach-welcome">
        <span>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</span>,
        <span id="athleteFullName"></span>
      </h2>

      <button id="openChatFromAthlete" class="btn-primary">
        üí¨ <span>–ß–∞—Ç</span>
      </button>
    </div>

    <!-- 2x2 Grid for menu items -->
    <section class="coach-menu">
      <a href="athlete_progress.html" class="coach-menu__item">
        <div class="coach-menu__icon">üìä</div>
        <div class="coach-menu__text">
          <div class="coach-menu__title">–ü—Ä–æ–≥—Ä–µ—Å—Å</div>
          <div class="coach-menu__sub">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
        </div>
      </a>

      <a href="athlete_workouts.html" class="coach-menu__item">
        <div class="coach-menu__icon">üí™</div>
        <div class="coach-menu__text">
          <div class="coach-menu__title">–ú–æ–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</div>
          <div class="coach-menu__sub">–ü–ª–∞–Ω—ã –æ—Ç —Ç—Ä–µ–Ω–µ—Ä–∞</div>
        </div>
      </a>

      <a href="athlete_tasks.html" class="coach-menu__item">
        <div class="coach-menu__icon">üìù</div>
        <div class="coach-menu__text">
          <div class="coach-menu__title">–ó–∞–¥–∞–Ω–∏—è</div>
          <div class="coach-menu__sub">–ó–∞–¥–∞—á–∏ –æ—Ç —Ç—Ä–µ–Ω–µ—Ä–∞</div>
        </div>
      </a>

      <a href="athlete_notifications.html" class="coach-menu__item">
        <div class="coach-menu__icon">üîî</div>
        <div class="coach-menu__text">
          <div class="coach-menu__title">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
          <div class="coach-menu__sub">–°–æ–æ–±—â–µ–Ω–∏—è –∏ —Å—Ç–∞—Ç—É—Å—ã</div>
        </div>
      </a>
    </section>
  </section>

  <!-- Activity panel now in center column below menu -->
  <section class="panel activity-panel activity-panel--dashboard">
    <div class="panel-header">
      <h2 class="page-subtitle">–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h2>
    </div>
    <div id="athleteActivity" class="list muted">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  </section>

</main>

<script>
  const API = "http://127.0.0.1:7003";

  const raw = localStorage.getItem("user");
  if (!raw) window.location.href = "login.html";

  const user = JSON.parse(raw);
  if (user.role !== "athlete") window.location.href = "login.html";

  document.getElementById("athleteName").textContent = user.username || "";
  document.getElementById("athleteFullName").textContent = user.last_name ? `${user.username} ${user.last_name}` : (user.username || "");
  document.getElementById("athleteIdValue").textContent = user.id ?? "";
  document.getElementById("athleteEmailValue").textContent = user.email ?? "";
  document.getElementById("athleteSportValue").textContent = user.sport ?? "‚Äî";

  const first = (user.username || "").trim()[0];
  document.getElementById("athleteAvatarLetter").textContent = first ? first.toUpperCase() : "A";

  document.getElementById("editProfileBtn").onclick = () => {
    window.location.href = "profile_edit.html";
  };

  document.getElementById("openChatFromAthlete").onclick = () => {
    window.location.href = "chat.html";
  };

  async function loadAthleteActivity(){
    const el = document.getElementById("athleteActivity");
    el.innerHTML = `<div class="muted">–ó–∞–≥—Ä—É–∑–∫–∞...</div>`;

    try {
      const res = await fetch(`${API}/api/activity?user_id=${user.id}&limit=6`);
      if (!res.ok) {
        el.innerHTML = `<div class="muted">–ü–æ–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–µ—Ç</div>`;
        return;
      }
      const data = await res.json().catch(()=>[]);
      if (!Array.isArray(data) || data.length === 0) {
        el.innerHTML = `<div class="muted">–ü–æ–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–µ—Ç</div>`;
        return;
      }

      el.innerHTML = data.map(a => `
        <div class="list-item">
          <div>
            <div class="list-title">${a.title || "–°–æ–±—ã—Ç–∏–µ"}</div>
            <div class="list-sub">${a.message || ""}</div>
          </div>
          <span class="badge">${a.created_at ? new Date(a.created_at).toLocaleString() : ""}</span>
        </div>
      `).join("");

    } catch (e) {
      console.error(e);
      el.innerHTML = `<div class="muted">–ü–æ–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–µ—Ç</div>`;
    }
  }

  loadAthleteActivity();
</script>

</body>
</html>
