<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SportTrack — Оповещения</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
<header class="top-bar">
  <div class="top-bar__logo">SportTrack</div>
  <button class="btn-link" onclick="history.back()">← Назад</button>
</header>

<main class="page">
  <h1 class="page-title">Оповещения</h1>

  <div class="panel">
    <div id="list" class="list"></div>
  </div>
</main>

<script>
const API = "http://127.0.0.1:7003";

const me = JSON.parse(localStorage.getItem("user") || "null");
if (!me || me.role !== "coach") location.href = "login.html";

const listEl = document.getElementById("list");

async function loadNotifs(){
  const res = await fetch(`${API}/api/notifications?user_id=${me.id}&limit=50`);
  return res.ok ? await res.json() : [];
}

async function markRead(nid){
  await fetch(`${API}/api/notifications/${nid}/read?user_id=${me.id}`, { method: "POST" });
}

function badge(status){
  if (status === "unread") return `<span class="badge warn">new</span>`;
  if (status === "accepted") return `<span class="badge success">accepted</span>`;
  if (status === "declined") return `<span class="badge">declined</span>`;
  return `<span class="badge">read</span>`;
}

async function getUserInfo(userId) {
  try {
    const res = await fetch(`${API}/api/users/${userId}`);
    if (!res.ok) return null;
    return await res.json();
  } catch (e) {
    return null;
  }
}

async function render(){
  const notifs = await loadNotifs();

  const usersMap = new Map();
  for (const n of notifs) {
    if (n.from_user_id && !usersMap.has(n.from_user_id)) {
      const userInfo = await getUserInfo(n.from_user_id);
      if (userInfo) usersMap.set(n.from_user_id, userInfo);
    }
  }

  listEl.innerHTML = notifs.length ? notifs.map(n => {
    const fromUser = n.from_user_id ? usersMap.get(n.from_user_id) : null;
    const userDisplay = fromUser 
      ? `<div class="list-sub notif-coach-info">
           <strong>От:</strong> ${fromUser.first_name || ''} ${fromUser.last_name || ''} (ID: ${fromUser.id})
         </div>`
      : '';
    
    return `
    <div class="list-item notif-clickable" onclick="openNotif(${n.id})">
      <div>
        <div class="list-title">${n.title} ${badge(n.status)}</div>
        <div class="list-sub">${n.message}</div>
        ${userDisplay}
      </div>
      <div class="muted notif-timestamp">${n.created_at || ""}</div>
    </div>
  `}).join("") : `<div class="muted">Пока пусто</div>`;
}

async function openNotif(nid){
  await markRead(nid);
  render();
}

render();
</script>
</body>
</html>
