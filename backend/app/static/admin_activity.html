<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SportTrack ‚Äî –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="lang.js"></script>

  <!-- Chart.js (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    .page-wrap { max-width: 1100px; margin: 0 auto; }
    .back-row { display:flex; align-items:center; gap:16px; margin: 12px 0 20px; }
    .title-big { font-family:"Rajdhani",sans-serif; font-size:44px; font-weight:900; letter-spacing:1px; margin:0; }

    .hint { color: rgba(255,255,255,.55); font-size: 12px; margin: 2px 0 0; }

    .cards {
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 16px;
      margin: 18px 0 18px;
    }
    @media (max-width: 980px){
      .cards { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 520px){
      .cards { grid-template-columns: 1fr; }
      .title-big { font-size: 34px; }
    }

    .stat-card {
      background: linear-gradient(135deg, rgba(0,153,255,.14), rgba(0,212,255,.06));
      backdrop-filter: blur(18px);
      border: 1px solid rgba(0,212,255,.18);
      border-radius: 18px;
      padding: 18px 18px;
      text-align: center;
      box-shadow: 0 12px 50px rgba(0,0,0,.25);
      min-height: 130px;
      display:flex;
      flex-direction: column;
      justify-content:center;
      gap: 8px;
    }
    .stat-emoji { font-size: 26px; opacity: .95; }
    .stat-value {
      font-family:"Rajdhani",sans-serif;
      font-size: 44px;
      font-weight: 900;
      color: #00d4ff;
      line-height: 1;
    }
    .stat-label {
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 1px;
      color: rgba(255,255,255,.75);
      text-transform: uppercase;
    }

    .grid2 { display:grid; grid-template-columns: 1fr; gap: 18px; }
    .panel-pad { padding: 18px 18px; border-radius: 22px; }
    .panel-title { margin: 0; font-size: 16px; color: rgba(255,255,255,.9); }
    .panel-sub { margin: 6px 0 0; font-size: 12px; color: rgba(255,255,255,.55); }

    .canvas-wrap {
      margin-top: 14px;
      background: rgba(0,0,0,.14);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 18px;
      padding: 14px;
    }

    .row-between { display:flex; align-items:center; justify-content:space-between; gap: 12px; flex-wrap: wrap; }
    .pill {
      font-size: 12px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.8);
      display:inline-flex;
      gap: 8px;
      align-items:center;
      user-select:none;
    }
    .pill b { color: #00d4ff; }

    .statusline {
      margin-top: 10px;
      font-size: 13px;
      color: rgba(255,255,255,.65);
    }
    .statusline.error { color: rgba(255,170,170,.95); }
    .statusline.success { color: rgba(170,255,200,.95); }
  </style>
</head>

<body>
<header class="top-bar">
  <div class="top-bar__logo" data-i18n="app_title">SportTrack</div>
  <div class="top-bar__lang">
    <select id="langSelect" class="lang-select">
      <option value="ru" data-i18n="lang_ru">–†—É—Å—Å–∫–∏–π</option>
      <option value="en" data-i18n="lang_en">English</option>
      <option value="kz" data-i18n="lang_kz">“ö–∞–∑–∞“õ—à–∞</option>
    </select>
  </div>
</header>

<main class="page">
  <div class="page-wrap">

    <div class="back-row">
      <a href="admin_page.html" class="btn-link">‚Üê –ù–∞–∑–∞–¥</a>
      <div>
        <h1 class="title-big">–°–¢–ê–¢–ò–°–¢–ò–ö–ê –ê–ö–¢–ò–í–ù–û–°–¢–ò</h1>
        <div class="hint">–î–∞–Ω–Ω—ã–µ –±–µ—Ä—É—Ç—Å—è –∏–∑ <b>/api/admin/activity-stats?admin_id=...</b></div>
      </div>
    </div>

    <section class="cards">
      <div class="stat-card">
        <div class="stat-emoji">üë•</div>
        <div class="stat-value" id="vUsers">‚Äî</div>
        <div class="stat-label">–≤—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
      </div>

      <div class="stat-card">
        <div class="stat-emoji">üèÉ</div>
        <div class="stat-value" id="vAthletes">‚Äî</div>
        <div class="stat-label">—Å–ø–æ—Ä—Ç—Å–º–µ–Ω–æ–≤</div>
      </div>

      <div class="stat-card">
        <div class="stat-emoji">üßë‚Äçüè´</div>
        <div class="stat-value" id="vCoaches">‚Äî</div>
        <div class="stat-label">—Ç—Ä–µ–Ω–µ—Ä–æ–≤</div>
      </div>

      <div class="stat-card">
        <div class="stat-emoji">üí™</div>
        <div class="stat-value" id="vTrainings">‚Äî</div>
        <div class="stat-label">—Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
      </div>
    </section>

    <section class="grid2">
      <section class="panel panel-pad">
        <div class="row-between">
          <div>
            <h2 class="panel-title">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h2>
            <div class="panel-sub">–°–∫–æ–ª—å–∫–æ –∞–¥–º–∏–Ω-–¥–µ–π—Å—Ç–≤–∏–π –ø–æ –¥–Ω—è–º (—Ç–∞–±–ª–∏—Ü–∞ admin_activity)</div>
          </div>
          <div class="pill">—Ç–æ—á–∫–∞ –¥–∞–Ω–Ω—ã—Ö: <b id="pActivityN">0</b></div>
        </div>
        <div class="canvas-wrap">
          <canvas id="activityChart" height="140"></canvas>
        </div>
      </section>

      <section class="panel panel-pad">
        <div class="row-between">
          <div>
            <h2 class="panel-title">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –º–µ—Å—è—Ü–∞–º</h2>
            <div class="panel-sub">–°–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å –ø–æ –º–µ—Å—è—Ü–∞–º (—Ç–∞–±–ª–∏—Ü–∞ users)</div>
          </div>
          <div class="pill">–º–µ—Å—è—Ü–µ–≤: <b id="pRegN">0</b></div>
        </div>
        <div class="canvas-wrap">
          <canvas id="regChart" height="140"></canvas>
        </div>
      </section>
    </section>

    <div id="statusLine" class="statusline">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>

  </div>
</main>

<script>
  const API = "";

  const raw = localStorage.getItem("user");
  if (!raw) location.href = "login.html";
  const me = JSON.parse(raw);

  if ((me.role || "").toLowerCase() !== "admin") location.href = "login.html";

  const elUsers = document.getElementById("vUsers");
  const elAthletes = document.getElementById("vAthletes");
  const elCoaches = document.getElementById("vCoaches");
  const elTrainings = document.getElementById("vTrainings");
  const statusLine = document.getElementById("statusLine");

  const pillActivityN = document.getElementById("pActivityN");
  const pillRegN = document.getElementById("pRegN");

  let activityChart = null;
  let regChart = null;

  function setStatus(text, ok=null){
    statusLine.textContent = text;
    statusLine.classList.remove("error","success");
    if (ok === true) statusLine.classList.add("success");
    if (ok === false) statusLine.classList.add("error");
  }

  function safeNum(x){
    const n = Number(x);
    return Number.isFinite(n) ? n : 0;
  }

  function renderActivityChart(activityArr){
    const arr = Array.isArray(activityArr) ? activityArr : [];
    pillActivityN.textContent = String(arr.length);

    const labels = arr.map(a => String(a.date ?? ""));
    const values = arr.map(a => safeNum(a.count));

    const ctx = document.getElementById("activityChart").getContext("2d");
    if (activityChart) activityChart.destroy();

    activityChart = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: "–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å",
          data: values,
          borderColor: "#00d4ff",
          backgroundColor: "rgba(0,212,255,0.18)",
          tension: 0.35,
          fill: true,
          pointRadius: 3,
          pointHoverRadius: 5
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: { enabled: true }
        },
        scales: {
          x: {
            ticks: { color: "rgba(255,255,255,.65)" },
            grid: { color: "rgba(255,255,255,.06)" }
          },
          y: {
            beginAtZero: true,
            ticks: { color: "rgba(255,255,255,.65)" },
            grid: { color: "rgba(255,255,255,.06)" }
          }
        }
      }
    });
  }

  function renderRegChart(regArr){
    const arr = Array.isArray(regArr) ? regArr : [];
    pillRegN.textContent = String(arr.length);

    const labels = arr.map(r => String(r.month ?? ""));
    const values = arr.map(r => safeNum(r.count));

    const ctx = document.getElementById("regChart").getContext("2d");
    if (regChart) regChart.destroy();

    regChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [{
          label: "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏",
          data: values,
          backgroundColor: "rgba(77,166,255,0.7)",
          borderColor: "rgba(77,166,255,1)",
          borderWidth: 1,
          borderRadius: 10
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: { enabled: true }
        },
        scales: {
          x: {
            ticks: { color: "rgba(255,255,255,.65)" },
            grid: { color: "rgba(255,255,255,.06)" }
          },
          y: {
            beginAtZero: true,
            ticks: { color: "rgba(255,255,255,.65)" },
            grid: { color: "rgba(255,255,255,.06)" }
          }
        }
      }
    });
  }

  async function loadStats(){
    setStatus("–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏‚Ä¶");
    try{
      const res = await fetch(`${API}/api/admin/activity-stats?admin_id=${encodeURIComponent(me.id)}`, {
        headers: { "Accept": "application/json" }
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data?.detail || ("HTTP " + res.status));


      const cards = data.cards || {};
      elUsers.textContent = safeNum(cards.total_users);
      elAthletes.textContent = safeNum(cards.athletes);
      elCoaches.textContent = safeNum(cards.coaches);
      elTrainings.textContent = safeNum(cards.trainings);

      renderActivityChart(data.activity || []);
      renderRegChart(data.registrations || []);

      setStatus("–ì–æ—Ç–æ–≤–æ ‚úÖ", true);
    } catch(e){
      console.error(e);
      elUsers.textContent = "0";
      elAthletes.textContent = "0";
      elCoaches.textContent = "0";
      elTrainings.textContent = "0";

      // –ø—É—Å—Ç—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ (—á—Ç–æ–±—ã –Ω–µ –ø–∞–¥–∞–ª–æ)
      renderActivityChart([]);
      renderRegChart([]);

      setStatus("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ (–ø—Ä–æ–≤–µ—Ä—å —Å–µ—Ä–≤–µ—Ä/endpoint) ‚ùå", false);
    }
  }

  loadStats();
</script>
</body>
</html>
