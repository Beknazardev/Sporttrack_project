<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SportTrack — Управление пользователями</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="lang.js"></script>

  <style>
    .page-wrap { max-width: 1100px; margin: 0 auto; padding: 28px 16px 60px; }

    .page-head {
      display:flex; align-items:center; justify-content:space-between;
      gap: 12px; margin-bottom: 18px;
    }
    .page-head-left { display:flex; align-items:center; gap: 14px; }
    .back-link { color:#7dd3fc; text-decoration:none; font-weight:600; }
    .page-title-big {
      font-family: "Rajdhani", sans-serif;
      letter-spacing: 2px;
      font-size: 42px; font-weight: 900; color: #fff;
      margin: 0;
    }

    .glass {
      background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 20px;
      backdrop-filter: blur(18px);
      box-shadow: 0 18px 60px rgba(0,0,0,0.35);
    }

    .toolbar {
      display:flex; gap: 12px; align-items:center; justify-content:space-between;
      padding: 14px;
      margin-bottom: 16px;
    }

    .tabs { display:flex; gap: 10px; flex-wrap:wrap; }
    .tab {
      border: 1px solid rgba(0,212,255,0.22);
      background: rgba(0,212,255,0.06);
      color: rgba(255,255,255,0.9);
      padding: 10px 14px;
      border-radius: 999px;
      cursor: pointer;
      transition: 0.2s ease;
      user-select: none;
      font-weight: 700;
      letter-spacing: 0.5px;
    }
    .tab:hover { transform: translateY(-1px); }
    .tab.active {
      background: rgba(0,212,255,0.18);
      border-color: rgba(0,212,255,0.45);
      color: #fff;
    }

    .searchbox { display:flex; gap: 10px; align-items:center; }
    .searchbox input {
      width: 320px; max-width: 52vw;
      padding: 11px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(0,0,0,0.18);
      color: #fff;
      outline: none;
    }
    .searchbox button {
      padding: 11px 14px;
      border-radius: 12px;
      border: 1px solid rgba(0,212,255,0.28);
      background: rgba(0,212,255,0.10);
      color: #fff;
      cursor: pointer;
      font-weight: 700;
    }

    .grid {
      display:grid;
      grid-template-columns: 1.6fr 1fr;
      gap: 16px;
    }
    @media (max-width: 980px){
      .grid { grid-template-columns: 1fr; }
    }

    .panel { padding: 16px; }

    table { width:100%; border-collapse: collapse; }
    th, td { padding: 12px 10px; text-align:left; }
    th {
      color: rgba(255,255,255,0.75);
      font-size: 12px; letter-spacing: 1px;
      text-transform: uppercase;
      border-bottom: 1px solid rgba(255,255,255,0.12);
    }
    tr.user-row { cursor:pointer; }
    tr.user-row:hover { background: rgba(255,255,255,0.05); }
    tr.user-row.active { background: rgba(0,212,255,0.08); }

    .badge {
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: #fff;
      font-size: 12px;
      font-weight: 700;
    }
    .badge.off { opacity: 0.55; }

    .muted { color: rgba(255,255,255,0.55); }
    .small { font-size: 12px; }

    .detail-title {
      font-family: "Rajdhani", sans-serif;
      font-size: 22px; font-weight: 800; margin: 0 0 12px; color:#fff;
    }

    .kv { display:grid; grid-template-columns: 120px 1fr; gap: 10px; }
    .kv div { padding: 6px 0; }
    .kv .k { color: rgba(255,255,255,0.55); }

    .field { margin-top: 12px; }
    .field label { display:block; margin-bottom: 6px; color: rgba(255,255,255,0.7); font-size: 12px; text-transform:uppercase; letter-spacing: 1px; }
    .field select {
      width: 100%;
      padding: 11px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(0,0,0,0.18);
      color: #fff;
      outline:none;
    }

    .actions { display:flex; gap: 10px; margin-top: 14px; flex-wrap: wrap; }
    .btn {
      padding: 11px 14px;
      border-radius: 12px;
      border: 1px solid rgba(0,212,255,0.28);
      background: rgba(0,212,255,0.10);
      color: #fff;
      cursor: pointer;
      font-weight: 800;
      letter-spacing: 0.3px;
    }
    .btn.danger {
      border-color: rgba(255,80,80,0.25);
      background: rgba(255,80,80,0.10);
    }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .status-line { margin-top: 10px; min-height: 18px; }
    .status-ok { color:#7CFFB2; }
    .status-err { color:#ff8a8a; }
  </style>
</head>

<body>
<header class="top-bar">
  <div class="top-bar__logo">SportTrack</div>
  <div class="top-bar__lang">
    <select id="langSelect" class="lang-select">
      <option value="ru">Русский</option>
      <option value="en">English</option>
      <option value="kz">Қазақша</option>
    </select>
  </div>
</header>

<main class="page-wrap">
  <div class="page-head">
    <div class="page-head-left">
      <a class="back-link" href="admin_page.html">← Назад</a>
      <h1 class="page-title-big">ПОЛЬЗОВАТЕЛИ</h1>
    </div>
  </div>

  <div class="glass toolbar">
    <div class="tabs" id="tabs">
      <div class="tab active" data-role="">Все</div>
      <div class="tab" data-role="admin">Админы</div>
      <div class="tab" data-role="coach">Тренеры</div>
      <div class="tab" data-role="athlete">Спортсмены</div>
    </div>

    <div class="searchbox">
      <input id="q" type="text" placeholder="Поиск по имени или email..." />
      <button id="searchBtn">Найти</button>
    </div>
  </div>

  <div class="grid">
    <section class="glass panel">
      <div class="muted small" style="margin-bottom:10px;">
        Нажми на строку — справа откроются действия (роль / блокировка).
      </div>

      <div id="tableWrap">
        <div class="muted">Загрузка...</div>
      </div>
    </section>

    <section class="glass panel">
      <h2 class="detail-title">Выбранный пользователь</h2>
      <div id="detailEmpty" class="muted">Выбери пользователя из списка слева.</div>

      <div id="detail" style="display:none;">
        <div class="kv">
          <div class="k">ID</div><div id="d_id"></div>
          <div class="k">Имя</div><div id="d_name"></div>
          <div class="k">Email</div><div id="d_email"></div>
          <div class="k">Роль</div><div id="d_role"></div>
          <div class="k">Статус</div><div id="d_active"></div>
        </div>

        <div class="field">
          <label>Новая роль</label>
          <select id="newRole">
            <option value="admin">admin</option>
            <option value="coach">coach</option>
            <option value="athlete">athlete</option>
          </select>
        </div>

        <div class="actions">
          <button class="btn" id="saveBtn">Сохранить</button>
          <button class="btn danger" id="toggleBtn">Заблокировать</button>
        </div>

        <div class="status-line" id="statusLine"></div>
      </div>
    </section>
  </div>
</main>

<script>
  const raw = localStorage.getItem("user");
  if (!raw) location.href = "login.html";
  const me = JSON.parse(raw);
  if ((me.role || "").toLowerCase() !== "admin") location.href = "login.html";
  const adminId = me.id;

  let currentRole = "";
  let currentQ = "";
  let users = [];
  let selected = null;

  function esc(s){ return (s ?? "").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;"); }

  function setStatus(text, ok=true){
    const el = document.getElementById("statusLine");
    el.className = "status-line " + (ok ? "status-ok" : "status-err");
    el.textContent = text || "";
  }

  async function fetchJSON(url, opts={}){
    const res = await fetch(url, opts);
    let data = null;
    try { data = await res.json(); } catch {}
    if (!res.ok){
      const msg = (data && (data.detail || data.message)) || ("HTTP " + res.status);
      throw new Error(msg);
    }
    return data;
  }

  function roleLabel(role){
    const r = (role || "").toLowerCase();
    if (r === "admin") return "admin";
    if (r === "coach") return "coach";
    return "athlete";
  }

  function renderTable(){
    const wrap = document.getElementById("tableWrap");
    if (!Array.isArray(users) || users.length === 0){
      wrap.innerHTML = `<div class="muted">Ничего не найдено</div>`;
      return;
    }

    const rows = users.map(u => {
      const isActive = !!u.is_active;
      const activeCls = isActive ? "" : "off";
      const activeText = isActive ? "активен" : "заблокирован";
      const isSel = selected && selected.id === u.id;

      const name = (u.last_name ? `${u.username || ""} ${u.last_name}` : (u.username || "—")).trim() || "—";
      return `
        <tr class="user-row ${isSel ? "active" : ""}" data-id="${u.id}">
          <td>${u.id}</td>
          <td>${esc(name)}</td>
          <td class="muted">${esc(u.email)}</td>
          <td><span class="badge">${esc(roleLabel(u.role))}</span></td>
          <td><span class="badge ${activeCls}">${esc(activeText)}</span></td>
        </tr>
      `;
    }).join("");

    wrap.innerHTML = `
      <table>
        <thead>
          <tr>
            <th style="width:70px;">ID</th>
            <th>Пользователь</th>
            <th>Email</th>
            <th style="width:110px;">Роль</th>
            <th style="width:140px;">Статус</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;

    wrap.querySelectorAll("tr.user-row").forEach(tr => {
      tr.addEventListener("click", () => {
        const id = Number(tr.dataset.id);
        const u = users.find(x => x.id === id);
        selectUser(u);
      });
    });
  }

  function selectUser(u){
    selected = u;
    renderTable();

    const empty = document.getElementById("detailEmpty");
    const detail = document.getElementById("detail");
    if (!u){
      empty.style.display = "block";
      detail.style.display = "none";
      return;
    }

    empty.style.display = "none";
    detail.style.display = "block";

    const name = (u.last_name ? `${u.username || ""} ${u.last_name}` : (u.username || "—")).trim() || "—";
    document.getElementById("d_id").textContent = u.id;
    document.getElementById("d_name").textContent = name;
    document.getElementById("d_email").textContent = u.email;
    document.getElementById("d_role").textContent = roleLabel(u.role);
    document.getElementById("d_active").textContent = u.is_active ? "активен" : "заблокирован";

    document.getElementById("newRole").value = roleLabel(u.role);

    const toggleBtn = document.getElementById("toggleBtn");
    toggleBtn.textContent = u.is_active ? "Заблокировать" : "Разблокировать";

    setStatus("");
  }

  async function loadUsers(){
    const wrap = document.getElementById("tableWrap");
    wrap.innerHTML = `<div class="muted">Загрузка...</div>`;
    try{
      const params = new URLSearchParams();
      params.set("admin_id", adminId);
      if (currentRole) params.set("role", currentRole);
      if (currentQ) params.set("q", currentQ);

      users = await fetchJSON(`/api/admin/users?` + params.toString());
      if (selected){
        // обновим selected из новых данных
        const fresh = users.find(x => x.id === selected.id);
        selected = fresh || null;
      }
      renderTable();
      if (selected) selectUser(selected);
      else selectUser(null);
    }catch(e){
      wrap.innerHTML = `<div class="muted">Ошибка загрузки: ${esc(e.message)}</div>`;
    }
  }

  async function saveChanges(){
    if (!selected) return;
    const saveBtn = document.getElementById("saveBtn");
    const toggleBtn = document.getElementById("toggleBtn");
    saveBtn.disabled = true; toggleBtn.disabled = true;
    setStatus("Сохраняю...", true);

    try{
      const newRole = document.getElementById("newRole").value;
      const body = { role: newRole };

      const params = new URLSearchParams();
      params.set("admin_id", adminId);

      const data = await fetchJSON(`/api/admin/users/${selected.id}?` + params.toString(), {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });

      setStatus("Готово ✅ " + (Array.isArray(data.changes) ? data.changes.join(", ") : ""), true);
      await loadUsers();
    }catch(e){
      setStatus("Ошибка: " + e.message, false);
    }finally{
      saveBtn.disabled = false; toggleBtn.disabled = false;
    }
  }

  async function toggleActive(){
    if (!selected) return;
    const saveBtn = document.getElementById("saveBtn");
    const toggleBtn = document.getElementById("toggleBtn");
    saveBtn.disabled = true; toggleBtn.disabled = true;
    setStatus("Сохраняю...", true);

    try{
      const newActive = !selected.is_active;
      const body = { is_active: newActive };

      const params = new URLSearchParams();
      params.set("admin_id", adminId);

      const data = await fetchJSON(`/api/admin/users/${selected.id}?` + params.toString(), {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });

      setStatus("Готово ✅ " + (Array.isArray(data.changes) ? data.changes.join(", ") : ""), true);
      await loadUsers();
    }catch(e){
      setStatus("Ошибка: " + e.message, false);
    }finally{
      saveBtn.disabled = false; toggleBtn.disabled = false;
    }
  }

  document.getElementById("searchBtn").addEventListener("click", () => {
    currentQ = document.getElementById("q").value.trim();
    loadUsers();
  });
  document.getElementById("q").addEventListener("keydown", (e) => {
    if (e.key === "Enter"){
      currentQ = document.getElementById("q").value.trim();
      loadUsers();
    }
  });

  document.getElementById("tabs").querySelectorAll(".tab").forEach(tab => {
    tab.addEventListener("click", () => {
      document.getElementById("tabs").querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      tab.classList.add("active");
      currentRole = tab.dataset.role || "";
      loadUsers();
    });
  });

  document.getElementById("saveBtn").addEventListener("click", saveChanges);
  document.getElementById("toggleBtn").addEventListener("click", toggleActive);

  loadUsers();
</script>
</body>
</html>
